# Kafka 설계 시 고려 사항 및 엔터프라이즈 사용 사례

Apache Kafka는 대규모 데이터 스트리밍과 실시간 데이터 처리에 최적화된 분산 메시징 시스템으로, 다양한 엔터프라이즈 환경에서 필수적인 요소로 자리 잡고 있습니다. 그러나 Kafka를 설계할 때는 각 시스템의 요구 사항에 따라 신중하게 아키텍처를 구성해야 합니다. 이번 글에서는 Kafka 설계 시 중요한 질문을 바탕으로 실제 사례와 함께 엔터프라이즈급 기업에서의 Kafka 활용 방식을 알아보겠습니다.

## 1. 메시지 손실이 허용되는가?

Kafka 설계 시 첫 번째로 고려해야 할 것은 메시지 손실에 대한 허용 여부입니다.

- **고려사항**: 메시지 손실을 허용할 수 없다면, `acks=all` 설정을 사용하여 모든 복제본에 메시지가 기록될 때까지 대기하도록 설정할 수 있습니다. 또한, 복제본 동기화 상태를 관리하는 `min.insync.replicas` 설정을 통해 메시지의 안전한 처리를 보장할 수 있습니다.

- **실제 사례**: 은행 거래 시스템에서는 메시지 손실이 치명적입니다. 모든 거래 정보는 반드시 복제되어야 하며, 메시지 손실이 발생하면 트랜잭션 처리에 문제가 생길 수 있기 때문에 `acks=all`과 복제 설정을 강화하여 메시지의 안전한 전달을 보장합니다. 반면, 소셜 미디어 알림 서비스에서는 일부 메시지가 손실되더라도 큰 문제가 없을 수 있습니다. 이러한 경우에는 `acks=1`로 설정하여 메시지 전송 속도를 우선시하고, 메시지 손실을 허용할 수 있습니다.

## 2. 데이터를 그룹화해야 하는가?

데이터 그룹화는 Kafka 파티셔닝과 관련이 있습니다. 파티셔닝을 통해 데이터를 논리적으로 구분하고, 데이터 일관성을 보장할 수 있습니다.

- **고려사항**: 특정 기준으로 데이터를 그룹화해야 한다면, Kafka 파티셔닝을 활용해 동일한 키에 대해 데이터가 같은 파티션에 기록되도록 할 수 있습니다. 이를 통해 그룹화된 데이터에 대한 순차 처리가 가능합니다.

- **실제 사례**: 이커머스 시스템에서 고객별 주문 처리를 할 때는 고객 ID를 파티션 키로 사용하여, 동일한 고객의 모든 주문이 같은 파티션에 저장되도록 합니다. 이를 통해 고객별로 주문 데이터 일관성을 유지할 수 있습니다. 로그 수집 시스템에서는 서버별 로그를 독립적으로 관리하기 위해 서버 ID를 파티션 키로 설정할 수 있습니다. 서버별로 로그 데이터를 그룹화함으로써 로그 분석을 더 쉽게 수행할 수 있습니다.

## 3. 특정 순서로 데이터를 전달해야 하는가?

메시지 순서가 중요한 시스템에서는 파티션 내에서 순서를 보장하는 Kafka의 특성을 활용할 수 있습니다.

- **고려사항**: 파티션 내에서는 메시지의 순서가 보장됩니다. 따라서 순서가 중요한 데이터는 반드시 같은 파티션에 기록되어야 하며, 파티션 키 선택이 매우 중요합니다. 여러 파티션에 데이터를 분산할 경우 순서 보장이 어렵기 때문에 주의해야 합니다.

- **실제 사례**: 결제 시스템에서 거래의 순서는 매우 중요합니다. 고객의 결제 요청이 순서대로 처리되어야 하기 때문에, 고객 ID를 파티션 키로 설정하여 고객의 모든 결제 요청이 동일한 파티션에서 처리되도록 해야 합니다. 반면, SNS 댓글 시스템에서는 전체적인 순서보다는 게시글 내의 댓글 순서가 더 중요합니다. 이 경우 게시글 ID를 파티션 키로 설정하여 댓글이 순서대로 처리되도록 설계할 수 있습니다.

## 4. 특정 항목의 마지막 값만 필요한가? 혹은 해당 항목의 이력이 중요한가?

Kafka에서는 모든 메시지를 로그로 남길지, 아니면 특정 항목의 마지막 값만 유지할지 결정해야 합니다.

- **고려사항**: 마지막 값만 필요할 경우 Kafka의 압축(compaction) 기능을 사용할 수 있습니다. 압축을 통해 동일한 키를 가진 이전 메시지를 삭제하고, 최신 메시지만 남겨놓을 수 있습니다. 반대로, 이력이 중요한 경우 모든 메시지를 로그에 남겨야 합니다.

- **실제 사례**: 기기 상태 모니터링 시스템에서 최신 기기 상태 정보만 필요하다면, Kafka의 로그 압축 기능을 활용하여 기기 ID별로 마지막 상태 정보만 유지할 수 있습니다. 반면, 재고 관리 시스템에서는 모든 재고 변동 이력이 필요합니다. 따라서 압축을 사용하지 않고 모든 메시지를 기록하여 재고 변화 추적이 가능하도록 합니다.

## 5. 얼마나 많은 컨슈머를 가질 것인가?

Kafka에서 컨슈머는 시스템의 성능을 좌우하는 중요한 요소입니다. 파티션 수와 컨슈머 수의 균형을 맞추는 것이 매우 중요합니다.

- **고려사항**: 파티션 수가 컨슈머 수보다 많을 경우, 각 컨슈머는 여러 파티션을 동시에 처리합니다. 반대로 컨슈머 수가 파티션 수보다 많으면, 일부 컨슈머는 대기 상태에 놓이게 됩니다. 따라서 적절한 파티션 수와 컨슈머 수를 설정해야 합니다.

- **실제 사례**: 데이터 분석 시스템에서는 대규모 데이터를 빠르게 처리하기 위해 여러 컨슈머를 사용해 파티션별로 병렬 처리를 수행합니다. 파티션과 컨슈머 수를 맞춰 성능을 극대화할 수 있습니다. 반면, 주문 처리 시스템에서는 메시지 순서가 중요하기 때문에 파티션당 하나의 컨슈머만 할당하여 데이터를 처리합니다. 이렇게 하면 순서를 유지하면서도 안정적으로 주문 처리를 할 수 있습니다.

## Kafka 설계 실제 사례 표

다음 표는 다양한 Kafka 사용 사례에서 메시지 손실 허용 여부, 데이터 그룹화 필요성, 순서 보장 필요성, 최종 값 필요 여부, 독립된 컨슈머 지원 여부를 바탕으로 설계된 예시입니다.

| 사용 용례               | 메시지 유실 가능성 | 데이터 그룹화 필요성 | 순서 보장 필요성 | 최종값만 필요 | 독립된 컨슈머 지원 필요성 |
| ----------------------- | ------------------ | -------------------- | ---------------- | ------------- | ------------------------- |
| 센서 API 감사 로깅      | NO                 | YES                  | NO               | NO            | YES                       |
| 은행 거래 시스템        | NO                 | YES                  | YES              | NO            | NO                        |
| 소셜 미디어 알림 서비스 | YES                | NO                   | NO               | YES           | YES                       |
| 고객 주문 처리 시스템   | NO                 | YES                  | YES              | NO            | NO                        |
| 기기 상태 모니터링      | YES                | NO                   | NO               | YES           | YES                       |
| 센서 Alert 관리         | NO                 | YES                  | NO               | YES           | YES                       |

이 표는 각 사용 사례에 맞춘 Kafka 설계를 설명하며, 시스템의 성격에 따라 Kafka를 어떻게 설계해야 하는지에 대한 인사이트를 제공합니다.

## 결론

Kafka 설계는 각 시스템의 요구 사항에 맞춰 최적화되어야 합니다. 메시지 손실 여부, 데이터 그룹화, 순서 보장, 데이터 보존 방식 및 컨슈머 수와 같은 중요한 요소들을 고려하여 적절한 아키텍처를 선택하는 것이 중요합니다. 위에서 설명한 엔터프라이즈 사례들을 바탕으로, Kafka를 통해 안정적이고 확장 가능한 시스템을 구축할 수 있습니다.

Kafka를 처음 설계하거나 엔터프라이즈 시스템에서 Kafka를 도입하는 경우, 이와 같은 설계 패턴을 통해 성능과 안정성을 최적화해보세요.
