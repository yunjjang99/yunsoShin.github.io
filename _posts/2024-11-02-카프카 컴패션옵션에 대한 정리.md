# Kafka의 컴팩션(compaction): 데이터 중복 제거와 최신 상태 유지의 비결

## Kafka는 대용량의 실시간 데이터 스트림을 처리하는 데 최적화된 메시지 브로커 시스템으로, 다양한 데이터 보관 옵션을 제공하여 데이터 관리의 유연성을 높여줍니다. 그중에서도 **컴팩션(compaction)**은 특정 상황에서 중복된 데이터를 줄이고, 최신 상태를 유지하기 위해 매우 유용한 기능입니다. 이번 글에서는 Kafka의 컴팩션이란 무엇인지, 어떤 상황에서 활용되는지와 함께 구체적인 예시로 알아보겠습니다.

## 컴팩션이란?

Kafka의 컴팩션은 **Log Compaction**이라고도 하며, 다음과 같은 주요 기능을 제공합니다:

1. **키 기반 중복 제거**: Kafka의 메시지는 "키-값" 형태로 저장되며, 컴팩션은 같은 키를 가진 메시지들 중 **가장 최신의 레코드만 남기고 이전 레코드는 삭제**하는 방식으로 작동합니다.
2. **데이터 영구적 유지**: 일반적인 Kafka의 **보관 정책(retention policy)**와는 별개로, 컴팩션된 데이터는 원하는 만큼 오래 보관할 수 있습니다. 이로 인해 **장기 데이터 보관**이 필요한 경우에도 유용하게 사용됩니다.
3. **삭제 키(tombstone)**: 특정 키에 대한 데이터를 완전히 삭제하려면 null 값을 가진 특별한 레코드인 "tombstone"을 사용합니다. 컴팩션은 이 tombstone을 만나면 해당 키의 데이터를 완전히 제거할 수 있습니다.

### 컴팩션의 특징

- **최신 상태 유지**: 컴팩션을 통해 모든 데이터 중 가장 최신 상태만 유지되므로, 특히 변경이 빈번한 데이터에서 유용합니다.
- **효율적인 메모리 사용**: 중복된 키를 제거함으로써 저장 공간을 절약하고, 검색 속도를 높일 수 있습니다.
- **비동기적 컴팩션**: 컴팩션은 Kafka의 백그라운드에서 비동기적으로 수행되며, 모든 메시지가 즉시 컴팩션되는 것은 아닙니다. 즉, **데이터 순서는 보장되지 않습니다**.

---

## 컴팩션이 사용되는 사례

컴팩션은 주로 **최신 상태만 중요하거나 중복 데이터가 필요하지 않은** 경우에 유용하게 사용됩니다. 아래에서는 컴팩션을 활용할 수 있는 몇 가지 일반적인 사례를 다루어 보겠습니다.

### 1. 사용자 프로필 관리 (`user_profile` 토픽)

**사용자 프로필 정보**와 같이 사용자의 최신 정보만 필요할 경우에 적합합니다. 사용자가 프로필을 업데이트할 때마다 Kafka 토픽에 새 메시지가 기록되며, 이때 각 사용자 ID를 키로 사용하여 컴팩션을 통해 최신 프로필 정보만 남길 수 있습니다.

#### 예시:

- **토픽 이름**: `user_profile`
- **키**: 사용자 ID (`user_id`)
- **값**: `{name: "Alice", age: 26, location: "Seoul"}`
- **사용 예시**: 사용자가 자신의 프로필을 업데이트할 때마다 해당 사용자 ID에 대한 최신 정보만 남기고, 이전 기록은 삭제됩니다.

컴팩션 후에는 각 사용자 ID에 대한 최신 프로필 정보만 남아 **데이터베이스와 유사한 최신 상태 저장소 역할**을 할 수 있습니다.

---

### 2. 상품 재고 관리 (`product_inventory` 토픽)

재고 관리에서는 **상품의 최신 재고 상태**만 중요합니다. 과거 재고 수량 기록은 필요하지 않기 때문에, 컴팩션을 통해 각 상품 ID에 대한 최신 재고 정보만 남기면 효율적입니다.

#### 예시:

- **토픽 이름**: `product_inventory`
- **키**: 상품 ID (`product_id`)
- **값**: `{productName: "Laptop", stock: 15}`
- **사용 예시**: 상품의 재고가 변경될 때마다 최신 재고 정보만 유지하고 이전 기록은 삭제됩니다.

컴팩션 적용 후에는 각 상품의 **현재 재고 수량**만 남아있어, 저장 공간을 절약하고 재고 조회 속도를 높일 수 있습니다.

---

### 3. 장비 상태 모니터링 (`device_status` 토픽)

사물인터넷(IoT) 시스템이나 네트워크 관리 시스템에서는 각 장비의 **최신 상태만 유지**하는 것이 중요합니다. 장비가 오프라인에서 온라인으로 전환되거나 배터리 상태가 변경되는 경우 최신 상태만을 남기고 이전 상태는 삭제하는 방식으로 관리할 수 있습니다.

#### 예시:

- **토픽 이름**: `device_status`
- **키**: 장비 ID (`device_id`)
- **값**: `{status: "online", battery: 85}`
- **사용 예시**: 장비 상태가 변경될 때마다 최신 상태만 남기고 이전 상태는 삭제됩니다.

이렇게 컴팩션을 적용하면 각 장비의 최신 상태 정보만 남아 **실시간 모니터링 시스템**에 적합하게 유지할 수 있습니다.

---

### 4. 주문 상태 관리 (`order_status` 토픽)

전자상거래나 주문 관리 시스템에서는 특정 주문의 최신 상태만 중요할 때가 많습니다. 예를 들어, 주문이 “처리 중”에서 “배송됨”으로 변경되면, “처리 중” 상태는 불필요해지므로 최신 상태만 유지할 수 있습니다.

#### 예시:

- **토픽 이름**: `order_status`
- **키**: 주문 ID (`order_id`)
- **값**: `{status: "shipped", estimatedDelivery: "2024-11-10"}`
- **사용 예시**: 주문 상태가 변경될 때마다 최신 상태만 남기고 이전 상태 기록은 삭제됩니다.

이렇게 컴팩션이 적용되면 각 주문의 **최신 상태만 유지**할 수 있어 주문 추적 시스템의 효율성을 높입니다.

---

### 5. 마지막 로그인 정보 관리 (`user_last_login` 토픽)

사용자의 로그인 기록 중 최신 로그인 정보만 필요할 때 컴팩션이 유용합니다. 특정 사용자의 로그인 기록을 저장하고, 최신 로그인 정보만 유지하면 데이터 관리에 큰 도움이 됩니다.

#### 예시:

- **토픽 이름**: `user_last_login`
- **키**: 사용자 ID (`user_id`)
- **값**: `{lastLogin: "2024-11-02T15:30:00Z"}`
- **사용 예시**: 사용자가 로그인할 때마다 최신 로그인 정보만 유지하고, 이전 로그인 기록은 삭제됩니다.

컴팩션을 통해 각 사용자의 **최신 로그인 시간만 유지**할 수 있어 불필요한 데이터 저장을 줄일 수 있습니다.

---

### 6. 상품 가격 정보 (`product_price` 토픽)

가격 변동이 빈번한 상품의 경우 최신 가격 정보만 남기고 이전 기록은 삭제할 수 있습니다. 이를 통해 각 상품의 현재 가격만 유지할 수 있습니다.

#### 예시:

- **토픽 이름**: `product_price`
- **키**: 상품 ID (`product_id`)
- **값**: `{price: 299.99}`
- **사용 예시**: 상품의 가격이 변경될 때마다 최신 가격 정보만 유지하고, 이전 가격 기록은 삭제됩니다.

각 상품의 최신 가격 정보만 유지하여 **가격 조회 속도와 데이터 저장 효율**을 높일 수 있습니다.

---

## 컴팩션 설정하기

Kafka에서 컴팩션을 활성화하려면 토픽 설정에서 `cleanup.policy`를 `"compact"`으로 설정해야 합니다.

```yaml
# Kafka 토픽 설정 예제
cleanup.policy=compact
```

이 설정을 추가하면, 해당 토픽에 대해 Kafka가 백그라운드에서 컴팩션을 주기적으로 수행합니다.

---

## 주의 사항

컴팩션이 활성화되면 데이터는 항상 최신 상태로 유지되지만, **모든 데이터가 즉시 컴팩션되지 않으며 순서도 보장되지 않습니다**. Kafka는 비동기적으로 컴팩션을 수행하기 때문에, 일부 레코드는 잠시 남아 있을 수 있으며 즉각적인 최신 상태가 반영되지는 않을 수 있습니다.

---
